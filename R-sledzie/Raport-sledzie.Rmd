---
title: "Raport - śledzie"
author: "FW"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document: 
    fig_caption: yes
    keep_md: yes
    number_sections: yes
    toc: yes
---

```{r setup, include=F}
knitr::opts_chunk$set(echo = T)
```

# Wstęp

// TODO 
Ponadto raport powinien zaczynać się od rozdziału podsumowującego całą analizę, streszczającego najważniejsze spostrzeżenia analityka.

# Wstępne przetwarzanie danych

## Kod wyliczający wykorzystane biblioteki.

Wykorzystano następujące biblioteki: 

```{r load_libraries, message=F, warning=F}
library(dplyr)
library(tidyr)
library(ggplot2)
library(plotly)
library(zoo)
library(reshape2)
```


## Kod pozwalający wczytać dane z pliku.

```{r load_data, echo=F, cache=T}
herring <- read.csv('sledzie.csv', na.strings = "?")
```

```{r dimensions, echo=F, cache=T}
dimens <- dim(herring)
```

Dane zawierają `r dimens[1]` próbek (wierszy) oraz `r dimens[2]` atrybutów (kolumn).

## Kod zapewniający powtarzalność wyników przy każdym uruchomieniu raportu na tych samych danych.
## Kod przetwarzający brakujące dane.

```{r deal_with_NA, echo=F, cache=T}
# use zoo library to insert value from previous row instead of NA
herring <- zoo::na.locf(herring, na.rm = F)
# remove NA from first line (or any other left)
herring <- herring %>% filter(complete.cases(.))
```


## Sekcję podsumowującą rozmiar zbioru i podstawowe statystyki.

W poniższej tabeli przedstawiono kilka pierwszych wierszy z tabeli: 

```{r head, cache=T}
knitr::kable(head(herring))
```

Oznaczenia kolumn:

* X: numer badania (chronologicznie);
* length: długość złowionego śledzia [cm];
* cfin1: dostępność planktonu [zagęszczenie Calanus finmarchicus gat. 1];
* cfin2: dostępność planktonu [zagęszczenie Calanus finmarchicus gat. 2];
* chel1: dostępność planktonu [zagęszczenie Calanus helgolandicus gat. 1];
* chel2: dostępność planktonu [zagęszczenie Calanus helgolandicus gat. 2];
* lcop1: dostępność planktonu [zagęszczenie widłonogów gat. 1];
* lcop2: dostępność planktonu [zagęszczenie widłonogów gat. 2];
* fbar: natężenie połowów w regionie [ułamek pozostawionego narybku];
* recr: roczny narybek [liczba śledzi];
* cumf: łączne roczne natężenie połowów w regionie [ułamek pozostawionego narybku];
* totaln: łączna liczba ryb złowionych w ramach połowu [liczba śledzi];
* sst: temperatura przy powierzchni wody [°C];
* sal: poziom zasolenia wody [Knudsen ppt];
* xmonth: miesiąc połowu [numer miesiąca];
* nao: oscylacja północnoatlantycka [mb].

Poniżej przedstawiono statystyki poszczególnych kolumn:

```{r summary, cache=T}
knitr::kable(summary(herring))
```

# Analiza danych

## Szczegółową analizę wartości atrybutów (np. poprzez prezentację rozkładów wartości).

```{r length(X), cache=T}
ggplot(herring, aes(x=X, y=length)) + geom_point() + geom_smooth() + theme_bw()
```

```{r length(X)_by_months, cache=T}
ggplot(herring, aes(x=X, y=length)) + geom_point() + geom_smooth() + theme_bw() + ylim(min(herring$length),max(herring$length)) + facet_wrap(~xmonth)
```

```{r totaln(X), cache=T}
ggplot(herring, aes(x=X, y=totaln)) + geom_point() + geom_smooth() + theme_bw()
```

```{r recr(X), cache=T}
ggplot(herring, aes(x=X, y=recr)) + geom_point() + geom_smooth() + theme_bw()
```

```{r food(X), cache=T}
food <- herring %>% gather(type, amount, cfin1:lcop2)
ggplot(food, aes(x = X, y = amount, colour = type)) + geom_smooth() + theme_bw()
```

Natężenie połowów w trakcie pomiaru oraz łączne roczne natężęnie połowów:

```{r fbar+cumf(X), cache=T}
fbar_cumf <- herring %>% gather(type, amount, c(fbar, cumf))
ggplot(fbar_cumf, aes(x = X, y = amount, colour = type)) + geom_point() + geom_smooth() + theme_bw()

```

Inne czynniki środowiskowe:

```{r sst(X), cache=T}
ggplot(herring, aes(x=X, y=sst)) + geom_point() + geom_smooth() + theme_bw()
```

```{r sal(X), cache=T}
ggplot(herring, aes(x=X, y=sal)) + geom_point() + geom_smooth() + theme_bw()
```

```{r nao(X), cache=T}
ggplot(herring, aes(x=X, y=nao)) + geom_point() + geom_smooth() + theme_bw()
```

## Sekcję sprawdzającą korelacje między zmiennymi; sekcja ta powinna zawierać jakąś formę graficznej prezentacji korelacji.

```{r correlation, cache=T}
# get correlation matrix
cor_matrix <- round(cor(herring, method="pearson"), 2)
# get lower triangle
cor_matrix[lower.tri(cor_matrix)] <- NA
# use reshape2 library to melt matrix for plotting
melted_cor_matrix <- melt(cor_matrix, na.rm = TRUE)
ggplot(data = melted_cor_matrix, aes(x=Var2, y=Var1, fill=value)) + geom_tile() + scale_fill_gradient2(low = "red", high = "green", mid = "gray", midpoint = 0, limit = c(-1,1), space = "Lab") + geom_text(aes(Var2, Var1, label = value), color = "black", size = 4) + theme_bw()
```



## Interaktywny wykres lub animację prezentującą zmianę rozmiaru śledzi w czasie.

```{r plotly, cache=T}
p <- ggplot(herring, aes(x=X, y=length)) + geom_smooth() + theme_bw()
ggplotly(p)
```


# Regresor

## Sekcję próbującą stworzyć regresor przewidujący rozmiar śledzia (w tej sekcji należy wykorzystać wiedzę z pozostałych punktów oraz wykonać dodatkowe czynności, które mogą poprawić trafność predykcji); dobór parametrów modelu oraz oszacowanie jego skuteczności powinny zostać wykonane za pomocą techniki podziału zbioru na dane uczące, walidujące i testowe; trafność regresji powinna zostać oszacowana na podstawie miar R2 i RMSE.


## Analizę ważności atrybutów najlepszego znalezionego modelu regresji. Analiza ważności atrybutów powinna stanowić próbę odpowiedzi na pytanie: co sprawia, że rozmiar śledzi zaczął w pewnym momencie maleć.


## Jeśli analityk uzna to za stosowne, powyższe punkty mogę być wykonane w innej kolejności. Analityk nie musi, a nawet nie powinien, ograniczać się do powyższych punktów. Wszelkie dodatkowe techniki analizy danych, wizualizacje, spostrzeżenia będą pozytwnie wpływały na ocenę.